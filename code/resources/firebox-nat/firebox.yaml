AWSTemplateFormatVersion: "2010-09-09"
Description: "Firebox Cloud"
Parameters: 
  ParamFireboxAMI:
    Type: String
    Default: ami-a844d4c8
    AllowedValues:
      - ami-ac1798cc #BYOL - c4.large and up
      - ami-a844d4c8 #Pay as you go - t2.micro or c4.large and up
  ParamInstanceType: 
    Type: String
    Default: t2.micro
    AllowedValues: 
      - t2.micro
      - c4.large
    Description: Choose an allowed instance type.
  ParamStackName: 
    Type: String
    Default: "firebox-trial"
    Description: "Name used in resource tags and names"
  ParamKeyName: 
    Type: String
    Default: ""
    Description: "EC2 Key Pair name for CLI Commands over SSH"
Resources:
  FireboxPublicNetworkInterface:
    Type: "AWS::EC2::NetworkInterface"
    Properties: 
      Description: Firebox Public Network Interface
      GroupSet:
        - !ImportValue FireboxPublicSecurityGroup
      SubnetId: 
        !ImportValue FireboxPublicSubnet
      SourceDestCheck: false
  FireboxPrivateNetworkInterface:
    Type: "AWS::EC2::NetworkInterface"
    Properties: 
      Description: Firebox Private Network Interface
      GroupSet: 
        - !ImportValue FireboxPrivateSecurityGroup
      SubnetId: 
        !ImportValue FireboxPrivateSubnet
  Firebox: 
    Type: "AWS::EC2::Instance"
    Properties: 
      ImageId: 
        Ref: ParamFireboxAMI
      InstanceType:
        Ref: ParamInstanceType
      NetworkInterfaces:
        - NetworkInterfaceId:
            Ref: FireboxPublicNetworkInterface
          DeviceIndex: '0'
        - NetworkInterfaceId:
            Ref: FireboxPrivateNetworkInterface
          DeviceIndex: '1'
      KeyName: !Ref ParamKeyName
      Tags:
        - Key: Name
          Value: FireboxCloud
        - Key: Stack
          Value: !Ref ParamStackName
Outputs:
  FireboxPrivateNetworkInterface:
    Value: !Ref FireboxPrivateNetworkInterface
    Export:
      Name: "FireboxPrivateNetworkInterface"
  FireboxPublicNetworkInterface:
    Value: !Ref FireboxPublicNetworkInterface
    Export:
      Name: "FireboxPublicNetworkInterface"
  Firebox:
    Value: !Ref Firebox
    Export:
      Name: "Firebox"
  FireboxPrimaryPrivateIpAddress:
    Value: !GetAtt FireboxPrivateNetworkInterface.PrimaryPrivateIpAddress
    Export:
      Name: "FireboxPrimaryPrivateIpAddress"
